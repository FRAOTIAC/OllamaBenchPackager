# 车载语音助手 - 精简核心改进计划

## 🎯 核心目标
- **输入**: 用户车载指令
- **输出**: 友好回复 + JSON工具调用格式
- **重点**: 0.5b小模型的多轮对话优化

## 📋 核心实现计划

### 1. **创建VehicleAssistant类**
```python
class VehicleAssistant:
    def __init__(self, model_name="qwen2:0.5b"):
        # 初始化模型和提示词
        # 设置上下文管理器
        
    def process_command(self, user_input):
        # 处理用户输入，返回回复+JSON
        
    def start_conversation(self):
        # 启动对话循环
```

### 2. **实现基础版提示词（0.5b优化）**
- 使用文档中的"基础版提示词"模板
- 重点：简洁明确，减少token消耗
- 严格的JSON格式要求
- 内置8种车辆功能映射

### 3. **JSON解析器**
```python
def parse_response(self, response):
    # 提取JSON部分
    # 验证三个必需字段：u_message, veh_object, veh_operation
    # 返回: (user_message, tool_call_json)
```

### 4. **上下文管理优化（核心重点）**
针对0.5b模型的短上下文限制：
- **压缩历史记录**：只保留最近2-3轮关键信息
- **智能摘要**：将长对话压缩为关键状态
- **上下文轮换**：超出长度时智能删除旧记录
- **状态跟踪**：记住当前车辆状态，避免重复询问

### 5. **基本验证**
- 验证veh_object是否在预定义列表中
- 验证veh_operation是否合法
- 简单的格式检查

### 6. **测试核心功能**
- 基础指令测试："打开空调"、"关闭车窗"等
- 多轮对话测试：连续操作指令
- 上下文管理测试：超出长度时的表现

## 🔧 多轮对话优化策略

### 上下文压缩示例：
```python
# 原始上下文（太长）
context = "User: 打开空调\nAssistant: 空调已开启\nUser: 调大风量\nAssistant: 风量已调大\nUser: 温度调低\nAssistant: 温度已调低"

# 压缩后（保持关键信息）
context = "空调:开启,风量:大,温度:低"
```

### 智能状态跟踪：
```python
vehicle_state = {
    "air_switch": "open",
    "air_volume": "high", 
    "air_temp": "low"
}
```

## 🎨 输出格式示例
```python
# 用户输入：打开空调
# 助手输出：
{
    "response": "嗖——空调启动啦！凉风正往你这边吹呢～",
    "tool_call": {
        "u_message": "嗖——空调启动啦！凉风正往你这边吹呢～",
        "veh_object": "air_switch", 
        "veh_operation": "open"
    }
}
```

## 🚀 任务清单

- [ ] 创建VehicleAssistant类
- [ ] 实现基础版提示词（0.5b优化）
- [ ] 添加JSON解析器
- [ ] 优化多轮对话的上下文管理
- [ ] 添加基本的车辆功能和操作验证
- [ ] 测试核心功能

## 📝 实现要点

### 针对0.5b模型的特殊优化
1. **简化提示词**：使用最简洁的指令格式
2. **压缩上下文**：智能保留关键信息
3. **状态跟踪**：避免重复传递相同信息
4. **快速响应**：减少不必要的处理步骤

### 核心功能优先级
1. **指令识别准确性** - 最高优先级
2. **JSON格式输出** - 高优先级  
3. **多轮对话体验** - 高优先级
4. **用户友好回复** - 中等优先级
5. **错误处理** - 中等优先级

这个精简计划专注于核心功能，特别是多轮对话的上下文管理优化，适合0.5b小模型的特点。 